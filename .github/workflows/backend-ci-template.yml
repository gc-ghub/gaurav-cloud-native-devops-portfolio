# Reusable CI workflow for backend services (build -> push -> update values.yaml -> commit)
name: "Backend CI Template (reusable)"

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string
      image_repo:
        required: true
        type: string
        description: "Full image repo (e.g. dockergc00/gc-devops-portfolio-backend-v1)"
      image_tag:
        required: true
        type: string
        description: "Tag to push (e.g. v2 or SHA short)"
      dockerfile_path:
        required: false
        type: string
        default: "."
      context:
        required: false
        type: string
        default: "."
      values_file:
        required: false
        type: string
        default: "phase2-portfolio/helm/portfolio/values.yaml"
      git_push_token:
        required: false
        type: string
        description: "Optional: use PERSONAL_ACCESS_TOKEN if you want commits from a user. If not provided, GITHUB_TOKEN is used."

permissions:
  contents: write     # needed to push commits / modify repo
  id-token: write     # optional if you want OIDC later

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE: ${{ inputs.image_repo }}
      TAG: ${{ inputs.image_tag }}
      VALUES_FILE: ${{ inputs.values_file }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU (for multi-platform builds)
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          logout: true

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile_path }}/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE }}:${{ env.TAG }}
            ${{ env.IMAGE }}:latest

      - name: Install yq (mikefarah)
        uses: mikeal/setup-yq@v1
        # Above action installs yq v4 - if the action name changes, replace accordingly.

      - name: Update values.yaml - set tag for backend service safely
        id: update_values
        run: |
          echo "Updating ${VALUES_FILE} -> set backend version ${INPUT_SERVICE} tag to ${TAG}"
          # Use mikefarah yq v4 expression to update the entry with the matching .name
          yq eval -i '
            (.backend.versions[] | select(.name == "'"${{ inputs.service_name }}"'") | .tag) = "'"${{ env.TAG }}"'"
          ' "${VALUES_FILE}"
          echo "Updated file content (excerpt):"
          yq eval '.backend.versions' "${VALUES_FILE}"

      - name: Show git status / diff
        run: |
          git status --porcelain
          git --no-pager diff --staged || true
          git --no-pager diff || true

      - name: Commit changed values.yaml
        id: commit
        run: |
          # Configure git author
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage and commit
          git add "${VALUES_FILE}"
          git commit -m "ci: update ${VALUES_FILE} -> set ${{ inputs.service_name }} tag to ${TAG}" || echo "No changes to commit"

          # Choose token: use provided token (PERSONAL_ACCESS_TOKEN) or default GITHUB_TOKEN
          if [ -n "${{ inputs.git_push_token }}" ]; then
            echo "Using provided PERSONAL token to push"
            git push "https://${{ inputs.git_push_token }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
          else
            echo "Using default GITHUB_TOKEN to push"
            # GITHUB_TOKEN is available as a secret `secrets.GITHUB_TOKEN` automatically injected in actions
            git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
          fi

      - name: Done
        run: echo "build-and-push completed for ${{ inputs.service_name }}:${{ env.TAG }}"
